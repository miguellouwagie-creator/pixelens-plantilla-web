---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
import { client } from "../lib/sanity";
import { urlFor } from "../lib/urlFor"; // <--- Importamos la utilidad

// 1. Pedimos los datos
// CAMBIO: Pedimos 'imagen' (objeto completo) en vez de 'imagen.asset->url'
const platos = await client.fetch(`*[_type == "plato"]{
  titulo,
  descripcion,
  precio,
  imagen, 
  categoria
}`) as any[];

// 2. LÓGICA MAESTRA: Agrupar platos por categoría
const platosPorCategoria = platos.reduce((acc, plato) => {
  const cat = plato.categoria || 'otros'; 
  if (!acc[cat]) acc[cat] = [];
  acc[cat].push(plato);
  return acc;
}, {});

// Definimos el orden en que queremos que salgan
const ordenCategorias = ['entrantes', 'principales', 'postres', 'bebidas', 'otros'];
---

<Layout title="Nuestra Carta | La Goleta">
  <Navbar />

  <div class="bg-stone-50 min-h-screen pb-20">
    <div class="bg-gray-900 text-white py-16 text-center px-6">
      <h1 class="text-5xl md:text-6xl italic mb-4 font-serif">Nuestra Propuesta</h1>
      <p class="text-gray-300 text-lg font-light max-w-2xl mx-auto">
        Sabores auténticos y producto de temporada.
      </p>
    </div>

    <main class="container mx-auto px-6 -mt-8">
      
      {ordenCategorias.map((categoria) => {
        // Si no hay platos en esta categoría, no pintamos nada
        if (!platosPorCategoria[categoria]) return null;

        return (
          <section class="mb-16">
            <div class="flex items-center justify-center mb-10 mt-12">
              <div class="h-px bg-gray-300 w-16"></div>
              <h2 class="mx-4 text-3xl font-bold text-gray-800 uppercase tracking-widest font-serif">
                {categoria}
              </h2>
              <div class="h-px bg-gray-300 w-16"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-10 max-w-5xl mx-auto">
              {platosPorCategoria[categoria].map((plato: any) => (
                <div class="group flex justify-between items-start border-b border-gray-200 pb-4 hover:border-gray-400 transition-colors">
                  
                  <div class="flex-1 pr-4">
                    <div class="flex justify-between items-baseline mb-1">
                      <h3 class="text-xl font-bold text-gray-900 group-hover:text-orange-700 transition-colors font-serif">
                        {plato.titulo}
                      </h3>
                      <span class="text-lg font-semibold text-gray-900 whitespace-nowrap ml-2 font-sans">
                        {plato.precio}
                      </span>
                    </div>
                    <p class="text-gray-500 text-sm font-light leading-relaxed italic">
                      {plato.descripcion}
                    </p>
                  </div>

                  {plato.imagen && (
                    <div class="w-20 h-20 flex-shrink-0 rounded-lg overflow-hidden shadow-sm ml-4">
                      <img 
                        src={urlFor(plato.imagen).width(200).height(200).format('webp').url()} 
                        alt={plato.titulo} 
                        class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                      />
                    </div>
                  )}
                </div>
              ))}
            </div>
          </section>
        );
      })}

    </main>
  </div>

  <Footer />
</Layout>